<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pusaq Admin Calendar Grid</title>
  <link rel="stylesheet" href="styles/admin-calendar-grid.css">
</head>
<body>

  <div class="top-bar">
    <div class="nav-buttons">
      <button onclick="changeMonth(-1)">â† Prev</button>
      <button onclick="changeMonth(1)">Next â†’</button>
    </div>
    <div class="filters">
      <select id="userFilter" onchange="renderCalendar()">
        <option value="">ğŸ‘¤ All Users</option>
      </select>
      <select id="projectFilter" onchange="renderCalendar()">
        <option value="">ğŸ“ All Projects</option>
      </select>
    </div>
    <a href="admin.html" style="background:#0053A6;color:white;padding:8px 14px;border-radius:6px;text-decoration:none;">â¬… Admin Dashboard</a>
  </div>

  <h1 id="monthTitle">ğŸ“… Calendar</h1>
  <div class="weekday-labels">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>
  <div class="calendar" id="calendarGrid"></div>

  <script src="backend.js"></script>
  <script>
    const currentUser = localStorage.getItem("user_name");
    const userRole = localStorage.getItem("user_role");

    if (!currentUser || userRole !== "admin") {
      alert("Access denied: Admins only.");
      window.location.href = "dashboard.html";
    }

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let allTasks = [];

    const userFilter = document.getElementById("userFilter");
    const projectFilter = document.getElementById("projectFilter");

    async function initialize() {
      try {
        const [users, projects, tasks] = await Promise.all([
          UserAPI.getAll(),
          ProjectAPI.getAll(),
          TaskAPI.getAll()
        ]);
        allTasks = tasks;

        users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.name;
          opt.textContent = u.name;
          userFilter.appendChild(opt);
        });

        projects.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          projectFilter.appendChild(opt);
        });

        renderCalendar();
      } catch (err) {
        console.error("Initialization failed:", err);
        alert("Failed to load calendar data.");
      }
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear -= 1;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear += 1;
      }
      renderCalendar();
    }

    function renderCalendar() {
      const monthTitle = document.getElementById("monthTitle");
      const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
      monthTitle.textContent = `ğŸ“… ${monthNames[currentMonth]} ${currentYear}`;

      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const firstWeekday = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      for (let i = 0; i < firstWeekday; i++) {
        const empty = document.createElement("div");
        empty.className = "day";
        grid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cellDate = new Date(currentYear, currentMonth, day);
        const dateStr = cellDate.toISOString().split("T")[0];

        const dayCell = document.createElement("div");
        dayCell.className = "day";
        dayCell.innerHTML = `<div class="date">${day}</div>`;

        const filtered = allTasks.filter(task => {
          return task.deadline === dateStr &&
                 (!userFilter.value || task.assignedTo === userFilter.value) &&
                 (!projectFilter.value || task.project === projectFilter.value);
        });

        filtered.forEach(task => {
          const badge = document.createElement("div");
          badge.className = `badge status-${task.status.replace(/\s/g, "\\ ")}`;
          badge.innerHTML = `${task.title} <span style="opacity:0.7;">(${task.assignedTo})</span>`;

          const tooltip = document.createElement("div");
          tooltip.className = "tooltip";
          tooltip.innerHTML = `
            <strong>${task.title}</strong><br>
            ğŸ‘¤ ${task.assignedTo}<br>
            ğŸ“ ${task.project}<br>
            ğŸ—“ï¸ ${task.deadline}<br>
            ğŸ·ï¸ ${task.status}<br>
            âœï¸ ${task.note || "No note"}
          `;
          badge.appendChild(tooltip);
          dayCell.appendChild(badge);
        });

        grid.appendChild(dayCell);
      }
    }

    initialize();
  </script>
</body>
</html>
