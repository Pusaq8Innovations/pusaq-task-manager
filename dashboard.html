<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pusaq Dashboard</title>
  <link rel="stylesheet" href="styles/dashboard.css">
</head>

<body>

  <div class="topbar">
    <img src="pusaq-logo.jpeg" alt="Pusaq Logo" />
    <div class="nav-links">
      <a href="calendar-grid.html">ğŸ“… Calendar</a>
      <a href="profile.html" id="profileBtn">ğŸ‘¤ Profile</a>
    </div>
  </div>

  <h1>ğŸ§  Your Tasks</h1>

  <div class="summary-bar">
    <strong id="taskSummaryText">Loading...</strong>
    <div class="progress-outer">
      <div class="progress-inner" id="summaryBar"></div>
    </div>
  </div>

  <!-- Floating comment input -->
  <div class="card">
    <h2>Floating Login Message ğŸ’¬</h2>
    <input type="text" id="floatingMessage" placeholder="Type your message for the login screen..." />
    <button onclick="saveFloatingMessage()">ğŸ’¾ Save Message</button>
  </div>

  <div class="accordion" id="taskContainer"></div>

  <script src="backend.js"></script> <!-- Importar backend.js -->

  <script>
    const currentUser = localStorage.getItem("user_name");
    if (!currentUser) {
      alert("Please log in.");
      window.location.href = "index.html";
    }

    document.getElementById("profileBtn").innerText = `ğŸ‘¤ ${currentUser}`;

    // âœ… Floating message field setup
    const messageInput = document.getElementById("floatingMessage");
    const savedMessage = localStorage.getItem(`comment_${currentUser}`);
    if (savedMessage) {
      messageInput.value = savedMessage;
    }

    function saveFloatingMessage() {
      const msg = messageInput.value.trim();
      localStorage.setItem(`comment_${currentUser}`, msg);
      alert("âœ… Message saved! Youâ€™ll see it on the login screen.");
    }

    // ğŸ”§ Tasks rendering
    let userTasks = [];

    async function fetchTasks() {
      try {
        // Llamada a la API para obtener las tareas usando TaskAPI
        userTasks = await TaskAPI.getAll();
        renderSummary();
        renderTasks();
      } catch (err) {
        console.error("Error fetching tasks:", err);
        alert("Error fetching tasks.");
      }
    }

    function renderSummary() {
      const total = userTasks.length;
      const completed = userTasks.filter(t => t.status === "Done" || t.progress == 100).length;
      const percent = total ? Math.round((completed / total) * 100) : 0;
      document.getElementById("taskSummaryText").innerText =
        `Youâ€™ve completed ${completed} of ${total} tasks (${percent}%)`;
      document.getElementById("summaryBar").style.width = percent + "%";
    }

    function renderTasks() {
      const container = document.getElementById("taskContainer");
      container.innerHTML = ""; // Clear any existing content

      userTasks.forEach(task => {
        const taskElement = document.createElement("div");
        taskElement.className = "task";
        taskElement.innerHTML = `
          <h3>${task.title}</h3>
          <p>Status: ${task.status}</p>
          <p>Progress: ${task.progress}%</p>
        `;
        container.appendChild(taskElement);
      });
    }

    fetchTasks();
  </script>

</body>

</html>
