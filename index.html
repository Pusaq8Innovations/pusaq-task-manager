<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Who's working today? - Pusaq</title>
  <link rel="stylesheet" href="styles/index.css">
  <link rel="stylesheet" href="styles/index.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

  <div class="logo">
    <img src="pusaq-logo1.jpeg" alt="Pusaq Logo" />
  </div>

  <h1>Who's working today?</h1>

  <div class="user-grid"></div>

  <!-- Floating comments overlay -->
  <div id="floating-comments-container"></div>

  <!-- Ahora usamos módulos -->
  <script type="module">
    import { getAllUsers, login, getUser } from './firebase.js';

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        console.log("Cargando usuarios...");
        const users = await getAllUsers();
        console.log("Usuarios cargados:", users);
        renderUsers(users);
      } catch (err) {
        console.error("Error al obtener usuarios:", err);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'No se pudieron cargar los usuarios.'
        });
      }
    });

    function renderUsers(users) {
      const container = document.querySelector(".user-grid");
      container.innerHTML = "";

      users.forEach(user => {
        const div = document.createElement("div");
        div.className = "user-box";
        div.onclick = () => promptPasswordAndLogin(user);

        div.innerHTML = `
          <img src="https://via.placeholder.com/100" alt="${user.name}" />
          <span>${user.name}</span>
        `;

        container.appendChild(div);
      });
    }

    async function promptPasswordAndLogin(user) {
      const { value: password } = await Swal.fire({
        title: `Contraseña para ${user.name}`,
        input: 'password',
        inputLabel: 'Ingresa tu contraseña',
        inputPlaceholder: 'Contraseña',
        inputAttributes: {
          maxlength: 50,
          autocapitalize: 'off',
          autocorrect: 'off'
        },
        showCancelButton: true,
        confirmButtonText: 'Ingresar'
      });

      if (!password) return; // Si canceló o no ingresó nada

      try {
        // Login a través de Firebase Auth
        const authUser = await login(user.email, password);

        // Obtener datos completos del usuario desde Firestore
        const userData = await getUser(authUser.uid);

        console.log('Usuario logueado:', userData);
        // Guardar el UID y nombre en localStorage
        localStorage.setItem("user_uid", authUser.uid);
        localStorage.setItem("user_name", userData.name);

        // Mostrar éxito
        await Swal.fire({
          icon: 'success',
          title: `¡Bienvenido, ${userData.name}!`,
          showConfirmButton: false,
          timer: 1500
        });

        // Mostrar éxito
        await Swal.fire({
          icon: 'success',
          title: `¡Bienvenido, ${userData.name}!`,
          showConfirmButton: false,
          timer: 1500
        });

        // Redirigir según el rol
        if (userData.role === "admin") {
          window.location.href = "admin.html";
        } else {
          window.location.href = "dashboard.html";
        }

      } catch (err) {
        console.error("Login error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Login fallido',
          text: 'Contraseña incorrecta o usuario no encontrado.'
        });
      }
    }
  </script>


</body>

</html>